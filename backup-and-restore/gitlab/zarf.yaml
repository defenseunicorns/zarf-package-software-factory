# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/zarf/v0.23.5/zarf.schema.json
kind: ZarfPackageConfig
metadata:
  name: di2me-gitlab-restorable-backup
  description: Zarf package for backing up and restoring GitLab in a DI2-ME environment. On package create, the backup will be pulled out of the cluster and added to the package. On deploy, the backup will be pushed into the cluster from the package and the restore process may optionally be initiated.
  url: https://github.com/defenseunicorns/zarf-package-software-factory/tree/main/backup-and-restore/gitlab
  version: "###ZARF_PKG_VAR_BACKUP_FILENAME###"

components:
  - name: gitlab-backup-artifacts
    description: "On package create, grabs the backup from the cluster and adds it to the package. On deploy, pushes the backup back into the cluster"
    required: true
    scripts:
      retry: false
      prepare:
        - "kubectl exec -i -n gitlab -c toolbox $(kubectl get pod -n gitlab -l app=toolbox -o jsonpath='{.items[0].metadata.name}') -- s3cmd get s3://gitlab-backups/###ZARF_PKG_VAR_BACKUP_FILENAME### /home/git/###ZARF_PKG_VAR_BACKUP_FILENAME###"
        - "kubectl cp -c toolbox gitlab/$(kubectl get pod -n gitlab -l app=toolbox -o jsonpath='{.items[0].metadata.name}'):home/git/###ZARF_PKG_VAR_BACKUP_FILENAME### ./###ZARF_PKG_VAR_BACKUP_FILENAME###"
#      after:
#        - "Push the package into the cluster"
    files:
      - source: "./###ZARF_PKG_VAR_BACKUP_FILENAME###"
        target: "./###ZARF_PKG_VAR_BACKUP_FILENAME###"
